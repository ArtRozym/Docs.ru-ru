---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: Code First Migrations и развертывание с помощью Entity Framework в приложении ASP.NET MVC | Документация Майкрософт
author: tdykstra
description: Пример веб-приложение университета Contoso демонстрирует создание приложения ASP.NET MVC 5, используя Entity Framework 6 Code First и Visual Studio...
ms.author: riande
ms.date: 10/08/2018
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 5c926c61cec5c7de43e2c3f0e377023b8ee799d0
ms.sourcegitcommit: a4dcca4f1cb81227c5ed3c92dc0e28be6e99447b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/10/2018
ms.locfileid: "48913025"
---
<a name="code-first-migrations-and-deployment-with-the-entity-framework-in-an-aspnet-mvc-application"></a><span data-ttu-id="c7a2e-103">Код первой миграции и развертывания с помощью Entity Framework в приложении ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="c7a2e-103">Code First migrations and deployment with the Entity Framework in an ASP.NET MVC application</span></span>
====================
<span data-ttu-id="c7a2e-104">по [том Дайкстра](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="c7a2e-104">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

[<span data-ttu-id="c7a2e-105">Скачать завершенный проект</span><span class="sxs-lookup"><span data-stu-id="c7a2e-105">Download Completed Project</span></span>](http://code.msdn.microsoft.com/ASPNET-MVC-Application-b01a9fe8)

> <span data-ttu-id="c7a2e-106">Пример веб-приложение университета Contoso демонстрирует создание приложения ASP.NET MVC 5, используя Entity Framework 6 Code First и Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-106">The Contoso University sample web application demonstrates how to create ASP.NET MVC 5 applications using the Entity Framework 6 Code First and Visual Studio.</span></span> <span data-ttu-id="c7a2e-107">Сведения о серии руководств см. в [первом руководстве серии](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-107">For information about the tutorial series, see [the first tutorial in the series](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span>

<span data-ttu-id="c7a2e-108">Пока приложение будет выполняться локально в IIS Express на компьютере разработчика.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-108">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="c7a2e-109">В реальном приложении сделать доступным для других пользователей в Интернете, необходимо развернуть его на веб-поставщик услуг размещения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-109">To make a real application available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="c7a2e-110">В этом руководстве вы развернете приложение университета Contoso в облако, в Azure.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-110">In this tutorial, you'll deploy the Contoso University application to the cloud in Azure.</span></span>

<span data-ttu-id="c7a2e-111">Учебник содержит следующие разделы:</span><span class="sxs-lookup"><span data-stu-id="c7a2e-111">The tutorial contains the following sections:</span></span>

- <span data-ttu-id="c7a2e-112">Включение Code First Migrations.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-112">Enable Code First Migrations.</span></span> <span data-ttu-id="c7a2e-113">Функция миграций позволяет изменить модель данных и развертывания изменений в рабочей среде путем обновления схемы базы данных без необходимости удаления и повторного создания базы данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-113">The Migrations feature enables you to change the data model and deploy your changes to production by updating the database schema without having to drop and re-create the database.</span></span>
- <span data-ttu-id="c7a2e-114">Развертывание в Azure.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-114">Deploy to Azure.</span></span> <span data-ttu-id="c7a2e-115">Этот шаг является необязательным; оставшихся учебниках можно будет продолжить без развернут проект.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-115">This step is optional; you can continue with the remaining tutorials without having deployed the project.</span></span>

<span data-ttu-id="c7a2e-116">Мы рекомендуем использовать процесс непрерывной интеграции с системой управления версиями для развертывания, что этот учебник не охватывает разделы.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-116">We recommend that you use a continuous integration process with source control for deployment, but this tutorial does not cover those topics.</span></span> <span data-ttu-id="c7a2e-117">Дополнительные сведения см. в разделе [система управления версиями](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) и [непрерывной интеграции](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) главах [Создание реальных облачных приложений в Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-117">For more information, see the [source control](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) and [continuous integration](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) chapters of [Building Real-World Cloud Apps with Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).</span></span>

## <a name="enable-code-first-migrations"></a><span data-ttu-id="c7a2e-118">Включение Code First migrations</span><span class="sxs-lookup"><span data-stu-id="c7a2e-118">Enable Code First migrations</span></span>

<span data-ttu-id="c7a2e-119">При разработке нового приложения ваша модель данных часто меняется, и при каждом таком изменении она нарушает синхронизацию с базой данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-119">When you develop a new application, your data model changes frequently, and each time the model changes, it gets out of sync with the database.</span></span> <span data-ttu-id="c7a2e-120">Вы настроили платформе Entity Framework автоматически удалить и повторно создать базу данных каждый раз при изменении модели данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-120">You have configured the Entity Framework to automatically drop and re-create the database each time you change the data model.</span></span> <span data-ttu-id="c7a2e-121">При Добавление, удаление, или изменении классов сущностей или изменении вашей `DbContext` класса, при следующем запуске приложения оно автоматически удаляет существующую базу данных, создает новый, который соответствует модели и заполняет ее тестовыми данными.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-121">When you add, remove, or change entity classes or change your `DbContext` class, the next time you run the application it automatically deletes your existing database, creates a new one that matches the model, and seeds it with test data.</span></span>

<span data-ttu-id="c7a2e-122">Этот способ для обеспечения синхронизации базы данных с моделью данных хорошо работает до развертывания приложения в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-122">This method of keeping the database in sync with the data model works well until you deploy the application to production.</span></span> <span data-ttu-id="c7a2e-123">Когда приложение выполняется в рабочей среде, оно обычно хранит данные, которые вы хотите сохранить, и вы не хотите потерять все, что каждый раз при внесении изменений, таких как добавление нового столбца.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-123">When the application is running in production, it is usually storing data that you want to keep, and you don't want to lose everything each time you make a change such as adding a new column.</span></span> <span data-ttu-id="c7a2e-124">[Code First Migrations](https://msdn.microsoft.com/data/jj591621) функция решает эту проблему, включив Code First обновить схему базы данных вместо удаления и повторного создания базы данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-124">The [Code First Migrations](https://msdn.microsoft.com/data/jj591621) feature solves this problem by enabling Code First to update the database schema instead of dropping and re-creating the database.</span></span> <span data-ttu-id="c7a2e-125">В этом руководстве вы развернете приложение, и для подготовки, вы будете разрешить миграции.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-125">In this tutorial, you'll deploy the application, and to prepare for that you'll enable Migrations.</span></span>

1. <span data-ttu-id="c7a2e-126">Отключить инициализатора, который мы настроили ранее, комментирования или удалив `contexts` элемент, добавленный в файл Web.config приложения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-126">Disable the initializer that you set up earlier by commenting out or deleting the `contexts` element that you added to the application Web.config file.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. <span data-ttu-id="c7a2e-127">Также в приложении *Web.config* файл, измените имя базы данных в строке подключения на ContosoUniversity2.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-127">Also in the application *Web.config* file, change the name of the database in the connection string to ContosoUniversity2.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    <span data-ttu-id="c7a2e-128">Это изменение настраивает проект, чтобы первой миграции создает новую базу данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-128">This change sets up the project so that the first migration creates a new database.</span></span> <span data-ttu-id="c7a2e-129">Это не является обязательным, но вы увидите Далее почему это хорошая идея.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-129">This isn't required but you'll see later why it's a good idea.</span></span>
3. <span data-ttu-id="c7a2e-130">В меню **Сервис** последовательно выберите пункты **Диспетчер пакетов NuGet** > **Консоль диспетчера пакетов**.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-130">From the **Tools** menu, select **NuGet Package Manager** > **Package Manager Console**.</span></span>

1. <span data-ttu-id="c7a2e-131">В `PM>` командной строке введите следующие команды:</span><span class="sxs-lookup"><span data-stu-id="c7a2e-131">At the `PM>` prompt enter the following commands:</span></span>

    ```text
    enable-migrations
    add-migration InitialCreate
    ```

    ![команды Enable-migrations](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image1.png)

    <span data-ttu-id="c7a2e-133">`enable-migrations` Команда создает *миграций* папки в проекте ContosoUniversity и он помещает в нее *Configuration.cs* файл, который можно изменять для настройки миграций.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-133">The `enable-migrations` command creates a *Migrations* folder in the ContosoUniversity project, and it puts in that folder a *Configuration.cs* file that you can edit to configure Migrations.</span></span>

    <span data-ttu-id="c7a2e-134">(Если вы пропустили на предыдущем шаге, который необходимо изменить имя базы данных, миграция будет найти существующую базу данных и автоматически выполнять `add-migration` команды.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-134">(If you missed the step above that directs you to change the database name, Migrations will find the existing database and automatically do the `add-migration` command.</span></span> <span data-ttu-id="c7a2e-135">Это нормально, это означает, что не будет работать, чтобы проверить код миграции перед развертыванием базы данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-135">That's okay, it just means you won't run a test of the migrations code before you deploy the database.</span></span> <span data-ttu-id="c7a2e-136">Более поздние версии, при запуске `update-database` команды, ничего не происходит, так как база данных уже существует.)</span><span class="sxs-lookup"><span data-stu-id="c7a2e-136">Later when you run the `update-database` command nothing will happen because the database already exists.)</span></span>

    ![Папку migrations](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image2.png)

    <span data-ttu-id="c7a2e-138">Как и класс инициализатора, который вы уже видели, `Configuration` класс включает `Seed` метод.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-138">Like the initializer class that you saw earlier, the `Configuration` class includes a `Seed` method.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    <span data-ttu-id="c7a2e-139">Цель [начальное значение](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) метод — научить вас вставлять или обновлять данные теста после Code First создает или обновляет базу данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-139">The purpose of the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is to enable you to insert or update test data after Code First creates or updates the database.</span></span> <span data-ttu-id="c7a2e-140">Метод вызывается при создании базы данных, и каждый раз при обновлении схемы базы данных после изменения модели данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-140">The method is called when the database is created and every time the database schema is updated after a data model change.</span></span>

### <a name="set-up-the-seed-method"></a><span data-ttu-id="c7a2e-141">Настройка метода заполнения</span><span class="sxs-lookup"><span data-stu-id="c7a2e-141">Set up the Seed method</span></span>

<span data-ttu-id="c7a2e-142">Если вы удалите и повторно создать базу данных для каждого изменения модели данных, используется класс инициализатора `Seed` метод вставляемый проверочных данных, так как база данных уничтожается после каждого изменения модели и все тестовые данные теряются.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-142">When you drop and re-create the database for every data model change, you use the initializer class's `Seed` method to insert test data, because after every model change the database is dropped and all the test data is lost.</span></span> <span data-ttu-id="c7a2e-143">С помощью Code First Migrations, тест, данные сохраняются после изменения базы данных, таким образом включая тестовых данных в [начальное значение](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) метод обычно не требуется.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-143">With Code First Migrations, test data is retained after database changes, so including test data in the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is typically not necessary.</span></span> <span data-ttu-id="c7a2e-144">На самом деле, вы не хотите `Seed` метод для вставки данных теста при использовании миграции для развертывания базы данных в рабочей среде, так как `Seed` метод будет выполняться в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-144">In fact, you don't want the `Seed` method to insert test data if you'll be using Migrations to deploy the database to production, because the `Seed` method will run in production.</span></span> <span data-ttu-id="c7a2e-145">В этом случае требуется `Seed` метод только данные, которые необходимо вставить в базу данных в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-145">In that case, you want the `Seed` method to insert into the database only the data that you need in production.</span></span> <span data-ttu-id="c7a2e-146">Например, может потребоваться базы данных, для включения названия фактическое отделов в `Department` таблицы, когда приложение становится доступным для рабочей среды.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-146">For example, you might want the database to include actual department names in the `Department` table when the application becomes available in production.</span></span>

<span data-ttu-id="c7a2e-147">В этом учебнике вы будете использовать миграции для развертывания, а `Seed` метод в любом случае Вставка тестовых данных для повышения его читаемости увидеть, как работает функциональных возможностей приложения без необходимости вручную вставить большие объемы данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-147">For this tutorial, you'll be using Migrations for deployment, but your `Seed` method will insert test data anyway in order to make it easier to see how application functionality works without having to manually insert a lot of data.</span></span>

1. <span data-ttu-id="c7a2e-148">Замените содержимое файла *Configuration.cs* файла следующий код, который загружает тестовые данные в новую базу данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-148">Replace the contents of the *Configuration.cs* file with the following code, which loads test data into the new database.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    <span data-ttu-id="c7a2e-149">[Начальное значение](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) метод принимает объект контекста базы данных как входной параметр и код в метод использует этот объект для добавления новых сущностей в базу данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-149">The [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method takes the database context object as an input parameter, and the code in the method uses that object to add new entities to the database.</span></span> <span data-ttu-id="c7a2e-150">Для каждого типа сущности, код создает коллекцию новых сущностей, добавляет их в соответствующий [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) свойства, а затем сохраняет изменения в базе данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-150">For each entity type, the code creates a collection of new entities, adds them to the appropriate [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) property, and then saves the changes to the database.</span></span> <span data-ttu-id="c7a2e-151">Нет необходимости вызывать [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) метод после каждой группы сущностей, как показано здесь, но это поможет вам найти источник проблемы, если возникает исключение, когда код записывает в базу данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-151">It isn't necessary to call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method after each group of entities, as is done here, but doing that helps you locate the source of a problem if an exception occurs while the code is writing to the database.</span></span>

    <span data-ttu-id="c7a2e-152">Некоторые операторы, которые вставляют данные используют [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) метод для выполнения операции «вставки-обновления».</span><span class="sxs-lookup"><span data-stu-id="c7a2e-152">Some of the statements that insert data use the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method to perform an "upsert" operation.</span></span> <span data-ttu-id="c7a2e-153">Так как `Seed` метод выполняется при каждом выполнении `update-database` команды обычно после каждую операцию миграции, нельзя просто вставить данные, так как строки, вы пытаетесь добавить уже будут существует после первой миграции, который создает базу данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-153">Because the `Seed` method runs every time you execute the `update-database` command, typically after each migration, you can't just insert data, because the rows you are trying to add will already be there after the first migration that creates the database.</span></span> <span data-ttu-id="c7a2e-154">Операция «вставки-обновления» позволяет избежать ошибок, произойдет при попытке вставить строку, которая уже существует, но он ***переопределяет*** любые изменения данных, внесенные во время тестирования приложения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-154">The "upsert" operation prevents errors that would happen if you try to insert a row that already exists, but it ***overrides*** any changes to data that you may have made while testing the application.</span></span> <span data-ttu-id="c7a2e-155">Тестовыми данными в некоторых таблицах вы не хотите, чтобы происходить: в некоторых случаях при изменении данных во время тестирования необходимым вам изменениям после обновления базы данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-155">With test data in some tables you might not want that to happen: in some cases when you change data while testing you want your changes to remain after database updates.</span></span> <span data-ttu-id="c7a2e-156">В этом случае необходимо выполнить операцию вставки условного: вставить строку, только в том случае, если он еще не существует.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-156">In that case you want to do a conditional insert operation: insert a row only if it doesn't already exist.</span></span> <span data-ttu-id="c7a2e-157">Метод заполнения использует оба подхода.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-157">The Seed method uses both approaches.</span></span>

    <span data-ttu-id="c7a2e-158">Первый параметр, передаваемый [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) метод задает свойство, используемое для проверки, если строка уже существует.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-158">The first parameter passed to the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method specifies the property to use to check if a row already exists.</span></span> <span data-ttu-id="c7a2e-159">Для тестовых данных учащихся, вы предоставляете `LastName` свойство может использоваться для этой цели, так как каждой фамилии в списке является уникальным:</span><span class="sxs-lookup"><span data-stu-id="c7a2e-159">For the test student data that you are providing, the `LastName` property can be used for this purpose since each last name in the list is unique:</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    <span data-ttu-id="c7a2e-160">Предполагается, что последний имена являются уникальными.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-160">This code assumes that last names are unique.</span></span> <span data-ttu-id="c7a2e-161">Если вручную добавить учащихся с повторяющимся именем последнего, вы получите следующее исключение при очередном выполнении миграции:</span><span class="sxs-lookup"><span data-stu-id="c7a2e-161">If you manually add a student with a duplicate last name, you'll get the following exception the next time you perform a migration:</span></span>

    <span data-ttu-id="c7a2e-162">**Последовательность содержит более одного элемента**</span><span class="sxs-lookup"><span data-stu-id="c7a2e-162">**Sequence contains more than one element**</span></span>

    <span data-ttu-id="c7a2e-163">Сведения о том, как обрабатывать избыточных данных, например с именем «Александр Carson» работы двух учащихся, см. в разделе [заполнения и отладка Entity Framework (EF) DBs](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) в блоге Рика Андерсона:.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-163">For information about how to handle redundant data such as two students named "Alexander Carson", see [Seeding and Debugging Entity Framework (EF) DBs](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) on Rick Anderson's blog.</span></span> <span data-ttu-id="c7a2e-164">Дополнительные сведения о `AddOrUpdate` метод, см. в разделе [Будьте внимательны с помощью метода AddOrUpdate 4.3 EF](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) блога Джули Лерман.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-164">For more information about the `AddOrUpdate` method, see [Take care with EF 4.3 AddOrUpdate Method](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) on Julie Lerman's blog.</span></span>

    <span data-ttu-id="c7a2e-165">Код, создающий `Enrollment` сущностей предполагается, что у вас есть `ID` значение в сущностях в `students` коллекции, несмотря на то, что вы не задали это свойство в коде, который создает коллекции.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-165">The code that creates `Enrollment` entities assumes you have the `ID` value in the entities in the `students` collection, although you didn't set that property in the code that creates the collection.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    <span data-ttu-id="c7a2e-166">Можно использовать `ID` здесь свойство поскольку `ID` имеет значение при вызове `SaveChanges` для `students` коллекции.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-166">You can use the `ID` property here because the `ID` value is set when you call `SaveChanges` for the `students` collection.</span></span> <span data-ttu-id="c7a2e-167">EF автоматически получает значение первичного ключа, если он вставляет сущность в базе данных, и обновляет `ID` свойство сущности в памяти.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-167">EF automatically gets the primary key value when it inserts an entity into the database, and it updates the `ID` property of the entity in memory.</span></span>

    <span data-ttu-id="c7a2e-168">Код, который добавляет каждое из них `Enrollment` сущность `Enrollments` набор сущностей не использует `AddOrUpdate` метод.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-168">The code that adds each `Enrollment` entity to the `Enrollments` entity set doesn't use the `AddOrUpdate` method.</span></span> <span data-ttu-id="c7a2e-169">Он проверяет, если сущность уже существует и вставляет сущность, если он не существует.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-169">It checks if an entity already exists and inserts the entity if it doesn't exist.</span></span> <span data-ttu-id="c7a2e-170">Такой подход позволяет сохранить изменения, внесенные в регистрации корпоративного класса с помощью пользовательского интерфейса приложения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-170">This approach will preserve changes you make to an enrollment grade by using the application UI.</span></span> <span data-ttu-id="c7a2e-171">Код просматривает каждый член `Enrollment` [списка](https://msdn.microsoft.com/library/6sh2ey19.aspx) и если регистрации не найден в базе данных, он добавляет регистрации к базе данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-171">The code loops through each member of the `Enrollment`[List](https://msdn.microsoft.com/library/6sh2ey19.aspx) and if the enrollment is not found in the database, it adds the enrollment to the database.</span></span> <span data-ttu-id="c7a2e-172">Первый раз, обновить базу данных, базы данных будут пусты, поэтому он добавляет каждой регистрации.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-172">The first time you update the database, the database will be empty, so it will add each enrollment.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]

2. <span data-ttu-id="c7a2e-173">Выполните построение проекта.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-173">Build the project.</span></span>

### <a name="execute-the-first-migration"></a><span data-ttu-id="c7a2e-174">Выполнение первой миграции</span><span class="sxs-lookup"><span data-stu-id="c7a2e-174">Execute the first migration</span></span>

<span data-ttu-id="c7a2e-175">При выполнении `add-migration` команды миграции созданный код, который создаст базу данных с нуля.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-175">When you executed the `add-migration` command, Migrations generated the code that would create the database from scratch.</span></span> <span data-ttu-id="c7a2e-176">Этот код присутствует также в *миграций* папку, в файл с именем  *&lt;timestamp&gt;\_InitialCreate.cs*.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-176">This code is also in the *Migrations* folder, in the file named *&lt;timestamp&gt;\_InitialCreate.cs*.</span></span> <span data-ttu-id="c7a2e-177">`Up` Метод `InitialCreate` класс создает таблицы базы данных, которые соответствуют наборам сущностей модели данных, и `Down` метод удаляет их.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-177">The `Up` method of the `InitialCreate` class creates the database tables that correspond to the data model entity sets, and the `Down` method deletes them.</span></span>

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

<span data-ttu-id="c7a2e-178">Функция миграций вызывает метод `Up`, чтобы реализовать изменения модели данных для миграции.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-178">Migrations calls the `Up` method to implement the data model changes for a migration.</span></span> <span data-ttu-id="c7a2e-179">При вводе команды для отката обновления функция миграций вызывает метод `Down`.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-179">When you enter a command to roll back the update, Migrations calls the `Down` method.</span></span>

<span data-ttu-id="c7a2e-180">Это связано с первоначальной миграции, который был создан, когда вы ввели `add-migration InitialCreate` команды.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-180">This is the initial migration that was created when you entered the `add-migration InitialCreate` command.</span></span> <span data-ttu-id="c7a2e-181">Параметр (`InitialCreate` в примере) используется для файла имя и может быть любым; обычно выбрать слово или фразу, которая обобщает, что необходимо сделать после миграции.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-181">The parameter (`InitialCreate` in the example) is used for the file name and can be whatever you want; you typically choose a word or phrase that summarizes what is being done in the migration.</span></span> <span data-ttu-id="c7a2e-182">Например, можно назвать миграцию &quot;AddDepartmentTable&quot;.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-182">For example, you might name a later migration &quot;AddDepartmentTable&quot;.</span></span>

<span data-ttu-id="c7a2e-183">Если вы создали первоначальную миграцию, когда база данных уже существовала, код для создания базы данных формируется, но выполнять его не требуется, так как база данных уже соответствует модели данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-183">If you created the initial migration when the database already exists, the database creation code is generated but it doesn't have to run because the database already matches the data model.</span></span> <span data-ttu-id="c7a2e-184">Однако при развертывании приложения в другой среде, где база данных еще не существует, этот код будет выполняться для создания базы данных, поэтому рекомендуется сначала его протестировать.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-184">When you deploy the app to another environment where the database doesn't exist yet, this code will run to create your database, so it's a good idea to test it first.</span></span> <span data-ttu-id="c7a2e-185">Вот почему вы изменили имя базы данных в строке подключения ранее&mdash;таким образом, чтобы миграций можно создать новую с нуля.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-185">That's why you changed the name of the database in the connection string earlier&mdash;so that migrations can create a new one from scratch.</span></span>

1. <span data-ttu-id="c7a2e-186">В **консоль диспетчера пакетов** окно, введите следующую команду:</span><span class="sxs-lookup"><span data-stu-id="c7a2e-186">In the **Package Manager Console** window, enter the following command:</span></span>

    `update-database`

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image3.png)

    <span data-ttu-id="c7a2e-187">`update-database` Выполняется команда `Up` метод для создания базы данных, а затем выполняется `Seed` метод для заполнения базы данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-187">The `update-database` command runs the `Up` method to create the database and then it runs the `Seed` method to populate the database.</span></span> <span data-ttu-id="c7a2e-188">Тот же процесс будет выполняться автоматически в рабочей среде после развертывания приложения, как можно будет увидеть в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-188">The same process will run automatically in production after you deploy the application, as you'll see in the following section.</span></span>
2. <span data-ttu-id="c7a2e-189">Используйте **обозревателя серверов** для проверки базы данных, как это делалось в первом руководстве и запустите приложение, чтобы убедиться, что все по-прежнему работает так же как и раньше.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-189">Use **Server Explorer** to inspect the database as you did in the first tutorial, and run the application to verify that everything still works the same as before.</span></span>

## <a name="deploy-to-azure"></a><span data-ttu-id="c7a2e-190">Развертывание в Azure</span><span class="sxs-lookup"><span data-stu-id="c7a2e-190">Deploy to Azure</span></span>

<span data-ttu-id="c7a2e-191">Пока приложение будет выполняться локально в IIS Express на компьютере разработчика.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-191">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="c7a2e-192">Чтобы сделать его доступным для других пользователей в Интернете, необходимо развернуть его на веб-поставщик услуг размещения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-192">To make it available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="c7a2e-193">В этом разделе руководства вы развернете его в Azure.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-193">In this section of the tutorial, you'll deploy it to Azure.</span></span> <span data-ttu-id="c7a2e-194">Этот раздел является необязательным; Вы можете пропустить этот шаг и продолжить к следующему учебнику, или можно изменить указания в этом разделе для другого поставщика услуг размещения по своему усмотрению.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-194">This section is optional; you can skip this and continue with the following tutorial, or you can adapt the instructions in this section for a different hosting provider of your choice.</span></span>

### <a name="use-code-first-migrations-to-deploy-the-database"></a><span data-ttu-id="c7a2e-195">Развертывание базы данных с помощью Code First migrations</span><span class="sxs-lookup"><span data-stu-id="c7a2e-195">Use Code First migrations to deploy the database</span></span>

<span data-ttu-id="c7a2e-196">Чтобы развернуть базу данных, используется Code First Migrations.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-196">To deploy the database, you'll use Code First Migrations.</span></span> <span data-ttu-id="c7a2e-197">При создании профиля публикации, который можно использовать для настройки параметров для развертывания из Visual Studio, будет предложено выбрать флажок **обновления базы данных**.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-197">When you create the publish profile that you use to configure settings for deploying from Visual Studio, you'll select a check box labeled **Update Database**.</span></span> <span data-ttu-id="c7a2e-198">Этот параметр задан, то процесс развертывания, чтобы автоматически настроить приложение *Web.config* файл на конечном сервере, таким образом, Code First использовал `MigrateDatabaseToLatestVersion` инициализатор класса.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-198">This setting causes the deployment process to automatically configure the application *Web.config* file on the destination server so that Code First uses the `MigrateDatabaseToLatestVersion` initializer class.</span></span>

<span data-ttu-id="c7a2e-199">Visual Studio не выполняет никаких действий с базой данных во время развертывания, хотя он копирует проекта на целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-199">Visual Studio doesn't do anything with the database during the deployment process while it is copying your project to the destination server.</span></span> <span data-ttu-id="c7a2e-200">При запуске развернутого приложения, и он обращается к базе данных в первый раз после развертывания, Code First проверяет, если базы данных соответствует модели данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-200">When you run the deployed application and it accesses the database for the first time after deployment, Code First checks if the database matches the data model.</span></span> <span data-ttu-id="c7a2e-201">Если существует несоответствие, Code First автоматически создает базу данных (если он еще не создан) или обновляет схему базы данных до последней версии (если база данных существует, но не соответствует модели).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-201">If there's a mismatch, Code First automatically creates the database (if it doesn't exist yet) or updates the database schema to the latest version (if a database exists but doesn't match the model).</span></span> <span data-ttu-id="c7a2e-202">Если приложение реализует миграций `Seed` метод выполнения метода, после создания или обновления схемы.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-202">If the application implements a Migrations `Seed` method, the method runs after the database is created or the schema is updated.</span></span>

<span data-ttu-id="c7a2e-203">Миграции `Seed` метод вставляет тестовых данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-203">Your Migrations `Seed` method inserts test data.</span></span> <span data-ttu-id="c7a2e-204">При развертывании в рабочей среде, вы должны внести изменения `Seed` метод, чтобы он вставляет только те данные, которые должны быть вставлены в рабочую базу данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-204">If you were deploying to a production environment, you would have to change the `Seed` method so that it only inserts data that you want to be inserted into your production database.</span></span> <span data-ttu-id="c7a2e-205">Например в текущей модели данных может потребоваться иметь реальных курсы, но вымышленной учащихся в базе данных разработки.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-205">For example, in your current data model you might want to have real courses but fictional students in the development database.</span></span> <span data-ttu-id="c7a2e-206">Можно написать `Seed` метод для загрузки в разработке и затем закомментируйте вымышленной учащихся, перед развертыванием в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-206">You can write a `Seed` method to load both in development, and then comment out the fictional students before you deploy to production.</span></span> <span data-ttu-id="c7a2e-207">Или можно написать `Seed` метод для загрузки только курсов и введите вымышленной учащихся в базе данных тестов вручную с помощью пользовательского интерфейса приложения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-207">Or you can write a `Seed` method to load only courses, and enter the fictional students in the test database manually by using the application's UI.</span></span>

### <a name="get-an-azure-account"></a><span data-ttu-id="c7a2e-208">Получить учетную запись Azure</span><span class="sxs-lookup"><span data-stu-id="c7a2e-208">Get an Azure account</span></span>

<span data-ttu-id="c7a2e-209">Вам потребуется учетная запись Azure.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-209">You'll need an Azure account.</span></span> <span data-ttu-id="c7a2e-210">Если у вас еще нет, но у вас есть подписка Visual Studio, вы можете [активировать свои преимущества](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-210">If you don't already have one, but you do have a Visual Studio subscription, you can [activate your subscription benefits](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
).</span></span> <span data-ttu-id="c7a2e-211">В противном случае можно создать бесплатную пробную учетную запись всего за несколько минут.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-211">Otherwise, you can create a free trial account in just a couple of minutes.</span></span> <span data-ttu-id="c7a2e-212">Дополнительные сведения см. в разделе [бесплатной пробной версии Azure](https://azure.microsoft.com/free/).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-212">For details, see [Azure Free Trial](https://azure.microsoft.com/free/).</span></span>

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a><span data-ttu-id="c7a2e-213">Создание веб-сайта и базы данных SQL в Azure</span><span class="sxs-lookup"><span data-stu-id="c7a2e-213">Create a web site and a SQL database in Azure</span></span>

<span data-ttu-id="c7a2e-214">Веб-приложения в Azure будет выполняться в общей среде размещения, это означает, что он работает на виртуальных машинах (ВМ), которые являются общими с другими клиентами Azure.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-214">Your web app in Azure will run in a shared hosting environment, which means it runs on virtual machines (VMs) that are shared with other Azure clients.</span></span> <span data-ttu-id="c7a2e-215">Общей среде размещения — это недорогой способ начать работу в облаке.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-215">A shared hosting environment is a low-cost way to get started in the cloud.</span></span> <span data-ttu-id="c7a2e-216">Позже Если ваш веб-трафик увеличится, приложение можно масштабировать для удовлетворения потребностей, выполнив на выделенных виртуальных машинах.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-216">Later, if your web traffic increases, the application can scale to meet the need by running on dedicated VMs.</span></span> <span data-ttu-id="c7a2e-217">Дополнительные сведения о ценах на параметры для службы приложений Azure, [цен на службу приложений](https://azure.microsoft.com/pricing/details/app-service/).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-217">To learn more about Pricing Options for Azure App Service, read [App Service pricing](https://azure.microsoft.com/pricing/details/app-service/).</span></span>

<span data-ttu-id="c7a2e-218">Используется для развертывания базы данных в базу данных Azure SQL.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-218">You'll deploy the database to Azure SQL database.</span></span> <span data-ttu-id="c7a2e-219">База данных SQL — это служба реляционной базы данных на основе облака, которая построена на технологиях SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-219">SQL database is a cloud-based relational database service that is built on SQL Server technologies.</span></span> <span data-ttu-id="c7a2e-220">Средства и приложения, работающие с SQL Server также работают с базой данных SQL.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-220">Tools and applications that work with SQL Server also work with SQL database.</span></span>

1. <span data-ttu-id="c7a2e-221">В [портала управления Azure](https://portal.azure.com), выберите **создать ресурс** в левой вкладке, а затем выберите **см. в разделе, все** на **New** области (или *колонке*) для просмотра всех доступных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-221">In the [Azure Management Portal](https://portal.azure.com), choose **Create a resource** in the left tab and then choose **See all** on the **New** pane (or *blade*) to see all available resources.</span></span> <span data-ttu-id="c7a2e-222">Выберите **веб-приложение + SQL** в **Web** раздел **все** колонке.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-222">Choose **Web App + SQL** in the **Web** section of the **Everything** blade.</span></span> <span data-ttu-id="c7a2e-223">Наконец, выберите **создать**.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-223">Finally, choose **Create**.</span></span>

    ![Создать ресурс на портале Azure](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/create-azure-resource.png)

   <span data-ttu-id="c7a2e-225">Форма для создания нового **новое веб-приложение + SQL** откроется ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-225">The form to create a new **New Web App + SQL** resource opens.</span></span>

2. <span data-ttu-id="c7a2e-226">Введите строку в **имя_приложения** поле для использования в качестве уникального URL-адреса для вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-226">Enter a string in the **App name** box to use as the unique URL for your application.</span></span> <span data-ttu-id="c7a2e-227">Полный URL-адрес будет состоять из введенной здесь плюс домена службы приложений по умолчанию (. azurewebsites.net).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-227">The complete URL will consist of what you enter here plus the default domain of Azure App Services (.azurewebsites.net).</span></span> <span data-ttu-id="c7a2e-228">Если **имя_приложения** уже занято, мастер сообщит с красным значком *имя приложения Недоступно* сообщения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-228">If the **App name** is already taken, the Wizard notifies you with a red *The app name is not available* message.</span></span> <span data-ttu-id="c7a2e-229">Если **имя_приложения** будет доступен, появится зеленая галочка.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-229">If the **App name** is available, you see a green checkmark.</span></span>

    ![Создание со ссылкой на базу данных на портале управления](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/create-web-app-sql-resource.png)

3. <span data-ttu-id="c7a2e-231">В **подписки** , выберите подписку Azure, в котором нужно **службы приложений** находиться.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-231">In the **Subscription** box, choose the Azure Subscription in which you want the **App Service** to reside.</span></span>

4. <span data-ttu-id="c7a2e-232">В **группы ресурсов** текстовое поле, выберите группу ресурсов или создайте новую.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-232">In the **Resource Group** text box, choose a Resource Group or create a new one.</span></span> <span data-ttu-id="c7a2e-233">Этот параметр указывает, какой веб-сайт будет выполняться в центр обработки данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-233">This setting specifies which data center your web site will run in.</span></span> <span data-ttu-id="c7a2e-234">Дополнительные сведения о группах ресурсов см. в разделе [групп ресурсов](/azure/azure-resource-manager/resource-group-overview#resource-groups).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-234">For more information about Resource Groups, see [Resource groups](/azure/azure-resource-manager/resource-group-overview#resource-groups).</span></span>

5. <span data-ttu-id="c7a2e-235">Создайте новый **план службы приложений** , щелкнув *разделе службы приложений*, **Create New**и заполните **план службы приложений** (может быть совпадает с именем Служба приложений), **расположение**, и **Ценовая** (есть бесплатный вариант).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-235">Create a new **App Service Plan** by clicking the *App Service section*, **Create New**, and fill in **App Service plan** (can be same name as App Service), **Location**, and **Pricing tier** (there is a free option).</span></span>

6. <span data-ttu-id="c7a2e-236">Нажмите кнопку **базы данных SQL**, а затем выберите **создать новую базу данных** или выберите существующую базу данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-236">Click **SQL Database**, and then choose **Create a new database** or select an existing database.</span></span>

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/new-sql-database.png)

7. <span data-ttu-id="c7a2e-237">В **имя** введите имя для базы данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-237">In the **Name** box, enter a name for your database.</span></span>
8. <span data-ttu-id="c7a2e-238">Нажмите кнопку **целевой сервер** поле, а затем выберите **Создание нового сервера**.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-238">Click the **Target Server** box, and then select **Create a new server**.</span></span> <span data-ttu-id="c7a2e-239">Кроме того Если ранее вы создали сервер, можно выбрать этот сервер из списка доступных серверов.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-239">Alternatively, if you previously created a server, you can select that server from list of available servers.</span></span>
9. <span data-ttu-id="c7a2e-240">Выберите **Ценовая** выберите *бесплатный*.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-240">Choose **Pricing tier** section, choose *Free*.</span></span> <span data-ttu-id="c7a2e-241">Если требуются дополнительные ресурсы, базы данных можно масштабировать в любое время.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-241">If additional resources are needed, the database can be scaled up at any time.</span></span> <span data-ttu-id="c7a2e-242">Дополнительные сведения о ценах на SQL Azure, см. в разделе [цен на базу данных SQL Azure](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-242">To learn more on Azure SQL Pricing, see [Azure SQL Database pricing](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span></span>
10. <span data-ttu-id="c7a2e-243">Изменить [параметры сортировки](/sql/relational-databases/collations/collation-and-unicode-support) при необходимости.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-243">Modify [collation](/sql/relational-databases/collations/collation-and-unicode-support) as needed.</span></span>
11. <span data-ttu-id="c7a2e-244">Введите администратора **имя пользователя администратора SQL** и **пароль администратора SQL**.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-244">Enter an administrator **SQL Admin Username** and **SQL Admin Password**.</span></span>

   - <span data-ttu-id="c7a2e-245">Если вы выбрали **новую базу данных SQL server**, определить новое имя и пароль, который будет использоваться в дальнейшем при доступе к базе данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-245">If you selected **New SQL Database server**, define a new name and password that you'll use later when you access the database.</span></span>
   - <span data-ttu-id="c7a2e-246">Если вы выбрали сервера, который вы создали ранее, введите учетные данные для этого сервера.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-246">If you selected a server that you created previously, enter credentials for that server.</span></span>

12. <span data-ttu-id="c7a2e-247">Сбор данных телеметрии можно включить для службы приложений с помощью Application Insights.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-247">Telemetry collection can be enabled for App Service using Application Insights.</span></span> <span data-ttu-id="c7a2e-248">С небольшой конфигурацией Application Insights собирает полезные события, исключения, зависимости, запрос и сведения о трассировке.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-248">With little configuration, Application Insights collects valuable event, exception, dependency, request, and trace information.</span></span> <span data-ttu-id="c7a2e-249">Дополнительные сведения об Application Insights, см. в разделе [Azure Monitor](https://azure.microsoft.com/services/monitor/).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-249">To learn more about Application Insights, see [Azure Monitor](https://azure.microsoft.com/services/monitor/).</span></span>
13. <span data-ttu-id="c7a2e-250">Нажмите кнопку **создать** внизу, чтобы указать, что Вы завершили.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-250">Click **Create** at the bottom to indicate that you're finished.</span></span>

    <span data-ttu-id="c7a2e-251">Портал управления возвращает страницу панели мониторинга и **уведомления** область в верхней части страницы показывает, что создается сайт.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-251">The Management Portal returns to the Dashboard page, and the **Notifications** area at the top of the page shows that the site is being created.</span></span> <span data-ttu-id="c7a2e-252">Через некоторое время (обычно это занимает меньше минуты) есть уведомление об успешном выполнении развертывания.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-252">After a while (typically less than a minute), there's a notification that the Deployment succeeded.</span></span> <span data-ttu-id="c7a2e-253">На панели навигации слева с новой службой приложений отображается в **службы приложений** раздел и новую базу данных SQL отображается в **баз данных SQL** раздел.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-253">In the navigation bar at the left, the new App Service appears in the **App Services** section and the new SQL database appears in the **SQL databases** section.</span></span>

### <a name="deploy-the-app-to-azure"></a><span data-ttu-id="c7a2e-254">Развертывание приложения в Azure</span><span class="sxs-lookup"><span data-stu-id="c7a2e-254">Deploy the app to Azure</span></span>

1. <span data-ttu-id="c7a2e-255">В Visual Studio щелкните правой кнопкой мыши проект в **обозревателе решений** и выберите **публикации** в контекстном меню.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-255">In Visual Studio, right-click the project in **Solution Explorer** and select **Publish** from the context menu.</span></span>

    ![Публикация элемента меню в обозревателе решений](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image10.png)

2. <span data-ttu-id="c7a2e-257">На **выберите целевой объект публикации** выберите **службы приложений** и затем **выбрать существующее**, а затем выберите **публикации**.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-257">On the **Pick a publish target** page, choose **App Service** and then **Select Existing**, and then choose **Publish**.</span></span>

    ![Выберите целевой страницы публикации](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/publish-select-existing-azure-app-service.png)

3. <span data-ttu-id="c7a2e-259">Если вы еще не добавили ранее подписки Azure Visual Studio, выполните действия на экране.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-259">If you haven't previously added your Azure subscription in Visual Studio, perform the steps on the screen.</span></span> <span data-ttu-id="c7a2e-260">Эти действия позволяют Visual Studio для подключения к подписке Azure таким образом, список **службы приложений** будет включать веб-сайт.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-260">These steps enable Visual Studio to connect to your Azure subscription so that the list of **App Services** will include your web site.</span></span>

4. <span data-ttu-id="c7a2e-261">На **службы приложений** выберите **подписки** вы добавили службы приложения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-261">On the **App Service** page, select the **Subscription** you added the App Service to.</span></span> <span data-ttu-id="c7a2e-262">В разделе **представление**выберите **группы ресурсов**.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-262">Under **View**, select **Resource Group**.</span></span> <span data-ttu-id="c7a2e-263">Разверните группу ресурсов, которую вы добавили службы приложения и затем выберите службу приложений.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-263">Expand the resource group you added the App Service to, and then select the App Service.</span></span> <span data-ttu-id="c7a2e-264">Выберите **ОК** для публикации приложения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-264">Choose **OK** to publish the app.</span></span>

    ![Выберите службу приложений](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/app-service-page.png)

5. <span data-ttu-id="c7a2e-266">**Вывода** окно показывает, какие действия по развертыванию были выполнены и передает об успешном завершении развертывания.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-266">The **Output** window shows what deployment actions were taken and reports successful completion of the deployment.</span></span>

    ![Окно вывода, отчетом об успешном развертывании](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/publish-output.png)

6. <span data-ttu-id="c7a2e-268">После успешного развертывания в браузере по умолчанию автоматически откроется на URL-адрес развернутого веб-сайта.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-268">Upon successful deployment, the default browser automatically opens to the URL of the deployed web site.</span></span>

    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/cloud-app-browser.png)

    <span data-ttu-id="c7a2e-270">Теперь ваше приложение работает в облаке.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-270">Your app is now running in the cloud.</span></span>

<span data-ttu-id="c7a2e-271">На этом этапе *SchoolContext* базы данных в базе данных Azure SQL создан, так как вы выбрали **выполнить Code First Migrations (при запуске приложения)**.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-271">At this point, the *SchoolContext* database has been created in the Azure SQL database because you selected **Execute Code First Migrations (runs on app start)**.</span></span> <span data-ttu-id="c7a2e-272">*Web.config* файл развернутого веб-узла был изменен, чтобы [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) инициализатор запускается в первый раз, код считывает или записывает данные в базе данных (что произошло При выборе **учащихся** вкладки):</span><span class="sxs-lookup"><span data-stu-id="c7a2e-272">The *Web.config* file in the deployed web site has been changed so that the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer runs the first time your code reads or writes data in the database (which happened when you selected the **Students** tab):</span></span>

![Выдержка из файла Web.config](https://asp.net/media/4367421/mig.png)

<span data-ttu-id="c7a2e-274">Процесс развертывания также создается новая строка подключения *(SchoolContext\_DatabasePublish*) для Code First Migrations для обновления схемы базы данных и заполнения базы данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-274">The deployment process also created a new connection string *(SchoolContext\_DatabasePublish*) for Code First Migrations to use for updating the database schema and seeding the database.</span></span>

![Строка подключения в файле Web.config](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

<span data-ttu-id="c7a2e-276">Вы найдете развернутой версии файла Web.config на локальном компьютере в *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. Доступ к развернутому *Web.config* сам файл с помощью FTP.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-276">You can find the deployed version of the Web.config file on your own computer in *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. You can access the deployed *Web.config* file itself by using FTP.</span></span> <span data-ttu-id="c7a2e-277">Инструкции см. в разделе [веб-развертывание ASP.NET с помощью Visual Studio: развертывание обновления кода](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-277">For instructions, see [ASP.NET Web Deployment using Visual Studio: Deploying a Code Update](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span></span> <span data-ttu-id="c7a2e-278">Следуйте инструкциям, которые начинаются с «Чтобы использовать средство FTP, необходимы три вещи: URL-адрес FTP, имя пользователя и пароль.»</span><span class="sxs-lookup"><span data-stu-id="c7a2e-278">Follow the instructions that start with "To use an FTP tool, you need three things: the FTP URL, the user name, and the password."</span></span>

> [!NOTE]
> <span data-ttu-id="c7a2e-279">Веб-приложение не реализует безопасности, поэтому любой кто найдет этот URL-адрес можно изменить данные.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-279">The web app doesn't implement security, so anyone who finds the URL can change the data.</span></span> <span data-ttu-id="c7a2e-280">Инструкции о том, как защитить веб-сайт, см. в разделе [развертывание безопасного приложения ASP.NET MVC с членством, OAuth и SQL базы данных в Azure](/aspnet/core/security/authorization/secure-data).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-280">For instructions on how to secure the web site, see [Deploy a Secure ASP.NET MVC app with Membership, OAuth, and SQL database to Azure](/aspnet/core/security/authorization/secure-data).</span></span> <span data-ttu-id="c7a2e-281">Можно запретить другим пользователям с помощью сайта, остановив службу, с помощью портала управления Azure или **обозревателя серверов** в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-281">You can prevent other people from using the site by stopping the service using the Azure Management Portal or **Server Explorer** in Visual Studio.</span></span>

![Остановить пункт меню приложения службы](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/server-explorer-stop-app-service.png)

## <a name="advanced-migrations-scenarios"></a><span data-ttu-id="c7a2e-283">Сценарии дополнительные миграции</span><span class="sxs-lookup"><span data-stu-id="c7a2e-283">Advanced migrations scenarios</span></span>

<span data-ttu-id="c7a2e-284">Если развернуть базу данных, выполнив миграции автоматически, как показано в этом руководстве развертывается на веб-сайт, который выполняется на нескольких серверах, можно получить несколько серверов, попытки запуска миграции, в то же время.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-284">If you deploy a database by running migrations automatically as shown in this tutorial, and you are deploying to a web site that runs on multiple servers, you could get multiple servers trying to run migrations at the same time.</span></span> <span data-ttu-id="c7a2e-285">Миграция являются атомарными, поэтому если же миграцию следует выполнять два сервера, один будет успешно, а другой не удастся (предполагается, что все действия нельзя выполнить дважды).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-285">Migrations are atomic, so if two servers try to run the same migration, one will succeed and the other will fail (assuming the operations can't be done twice).</span></span> <span data-ttu-id="c7a2e-286">Если вы хотите избежать этих проблем в этом сценарии можно вызывать миграции вручную и настроить собственный код, чтобы это происходит только один раз.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-286">In that scenario if you want to avoid those issues, you can call migrations manually and set up your own code so that it only happens once.</span></span> <span data-ttu-id="c7a2e-287">Дополнительные сведения см. в разделе [запущена и сценариев миграции из кода](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) в блоге Роуэн Миллер и [Migrate.exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (для выполнения миграции из командной строки).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-287">For more information, see [Running and Scripting Migrations from Code](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) on Rowan Miller's blog and [Migrate.exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (for executing migrations from the command line).</span></span>

<span data-ttu-id="c7a2e-288">Сведения о других сценариях миграции, см. в разделе [миграций серию](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-288">For information about other migrations scenarios, see [Migrations Screencast Series](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span></span>

## <a name="code-first-initializers"></a><span data-ttu-id="c7a2e-289">Инициализаторы первого кода</span><span class="sxs-lookup"><span data-stu-id="c7a2e-289">Code First initializers</span></span>

<span data-ttu-id="c7a2e-290">В разделе "Развертывание", встреченного [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) используется инициализатор.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-290">In the deployment section, you saw the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer being used.</span></span> <span data-ttu-id="c7a2e-291">Код сначала также предоставляет другие инициализаторы, включая [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (по умолчанию), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (который вы использовали ранее) и [ DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-291">Code First also provides other initializers, including [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (the default), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (which you used earlier) and [DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span></span> <span data-ttu-id="c7a2e-292">`DropCreateAlways` Инициализаторов может быть полезна для настройки условий для модульных тестов.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-292">The `DropCreateAlways` initializer can be useful for setting up conditions for unit tests.</span></span> <span data-ttu-id="c7a2e-293">Можно также написать собственные инициализаторы и инициализатор можно вызвать явным образом, если вы не хотите подождать, пока приложение для считывания и записи в базу данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-293">You can also write your own initializers, and you can call an initializer explicitly if you don't want to wait until the application reads from or writes to the database.</span></span>

<span data-ttu-id="c7a2e-294">Дополнительные сведения об инициализаторах см. в разделе [инициализаторы основные сведения о базе данных в Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) и главе 6 книги [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) с Джули Лерман и Роуэн Миллер.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-294">For more information about initializers, see [Understanding Database Initializers in Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) and chapter 6 of the book [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) by Julie Lerman and Rowan Miller.</span></span>

## <a name="summary"></a><span data-ttu-id="c7a2e-295">Сводка</span><span class="sxs-lookup"><span data-stu-id="c7a2e-295">Summary</span></span>

<span data-ttu-id="c7a2e-296">В этом руководстве вы узнали, как включить перенос и развертывание приложения.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-296">In this tutorial, you learned how to enable migrations and deploy the application.</span></span> <span data-ttu-id="c7a2e-297">В следующем руководстве вы начнете рассматривать более сложные вопросы, развернув модель данных.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-297">In the next tutorial, you'll begin looking at more advanced topics by expanding the data model.</span></span>

<span data-ttu-id="c7a2e-298">Оставьте свои отзывы на том, как вам понравилось, и этот учебник, и что можно улучшить.</span><span class="sxs-lookup"><span data-stu-id="c7a2e-298">Please leave feedback on how you liked this tutorial and what we could improve.</span></span>

<span data-ttu-id="c7a2e-299">Ссылки на другие ресурсы Entity Framework можно найти в [доступ к данным ASP.NET — рекомендуемые ресурсы](xref:whitepapers/aspnet-data-access-content-map).</span><span class="sxs-lookup"><span data-stu-id="c7a2e-299">Links to other Entity Framework resources can be found in [ASP.NET Data Access - Recommended Resources](xref:whitepapers/aspnet-data-access-content-map).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="c7a2e-300">[Назад](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)
> [Вперед](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-a-more-complex-data-model-for-an-asp-net-mvc-application)</span><span class="sxs-lookup"><span data-stu-id="c7a2e-300">[Previous](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)
[Next](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-a-more-complex-data-model-for-an-asp-net-mvc-application)</span></span>
