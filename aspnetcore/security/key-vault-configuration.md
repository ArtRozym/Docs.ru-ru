---
title: Поставщик конфигурации Azure Key Vault в ASP.NET Core
author: guardrex
description: Узнайте, как использовать поставщик конфигурации Azure Key Vault для настройки приложения с помощью пары "имя значение", загружен во время выполнения.
monikerRange: '>= aspnetcore-1.1'
ms.author: riande
ms.custom: mvc
ms.date: 08/01/2018
uid: security/key-vault-configuration
ms.openlocfilehash: 933f4fb1f2c1c412d318af5974cc9653805242ca
ms.sourcegitcommit: 25150f4398de83132965a89f12d3a030f6cce48d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/25/2018
ms.locfileid: "42927991"
---
# <a name="azure-key-vault-configuration-provider-in-aspnet-core"></a><span data-ttu-id="49105-103">Поставщик конфигурации Azure Key Vault в ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="49105-103">Azure Key Vault configuration provider in ASP.NET Core</span></span>

<span data-ttu-id="49105-104">По [Люк Лэтем](https://github.com/guardrex) и [Andrew Stanton медсестра](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="49105-104">By [Luke Latham](https://github.com/guardrex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

<span data-ttu-id="49105-105">В этом документе объясняется, как использовать [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) поставщик конфигурации для загрузки значений конфигурации из секреты Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="49105-105">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load app configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="49105-106">Azure Key Vault — это облачная служба, которая помогает защитить криптографические ключи и секреты, используемые приложениями и службами.</span><span class="sxs-lookup"><span data-stu-id="49105-106">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="49105-107">Обычные сценарии включают управление доступом к конфиденциальные данные конфигурации и соответствующие потребностям под стандарт FIPS 140-2 уровня 2 проверяются аппаратных модулей безопасности (HSM), при сохранении данных конфигурации.</span><span class="sxs-lookup"><span data-stu-id="49105-107">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="49105-108">Эта функция доступна для приложений, предназначенных для ASP.NET Core 1.1 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="49105-108">This feature is available for apps that target ASP.NET Core 1.1 or higher.</span></span>

<span data-ttu-id="49105-109">[Просмотреть или скачать образец кода](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples) ([как скачивать](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="49105-109">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="package"></a><span data-ttu-id="49105-110">Пакет</span><span class="sxs-lookup"><span data-stu-id="49105-110">Package</span></span>

<span data-ttu-id="49105-111">Чтобы воспользоваться поставщиком, добавьте ссылку на [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) пакета.</span><span class="sxs-lookup"><span data-stu-id="49105-111">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="app-configuration"></a><span data-ttu-id="49105-112">Конфигурация приложения</span><span class="sxs-lookup"><span data-stu-id="49105-112">App configuration</span></span>

<span data-ttu-id="49105-113">Вы можете изучить поставщика с [примеры приложений](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span><span class="sxs-lookup"><span data-stu-id="49105-113">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="49105-114">После установления хранилища ключей и создайте секреты в хранилище, примеры приложений безопасно загрузить значения секретов в их конфигурации и отобразить их на веб-страницах.</span><span class="sxs-lookup"><span data-stu-id="49105-114">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="49105-115">Поставщик добавляется в конфигурацию приложения с `AddAzureKeyVault` расширения.</span><span class="sxs-lookup"><span data-stu-id="49105-115">The provider is added to the app's configuration with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="49105-116">В образце приложения, расширение использует три значения конфигурации, загруженного из *appsettings.json* файла.</span><span class="sxs-lookup"><span data-stu-id="49105-116">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="49105-117">Параметр приложения</span><span class="sxs-lookup"><span data-stu-id="49105-117">App Setting</span></span>    | <span data-ttu-id="49105-118">Описание:</span><span class="sxs-lookup"><span data-stu-id="49105-118">Description</span></span>                    | <span data-ttu-id="49105-119">Пример</span><span class="sxs-lookup"><span data-stu-id="49105-119">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="49105-120">Имя хранилища ключей Azure</span><span class="sxs-lookup"><span data-stu-id="49105-120">Azure Key Vault name</span></span>           | <span data-ttu-id="49105-121">contosovault</span><span class="sxs-lookup"><span data-stu-id="49105-121">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="49105-122">Идентификатор приложения Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="49105-122">Azure Active Directory App Id</span></span>  | <span data-ttu-id="49105-123">627e911e-43cc-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="49105-123">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="49105-124">Ключ приложения Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="49105-124">Azure Active Directory App Key</span></span> | <span data-ttu-id="49105-125">g58K3dtg59o1Pa + e59v2Tx829w6VxTB2yv9sv/101di =</span><span class="sxs-lookup"><span data-stu-id="49105-125">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1)]

## <a name="create-key-vault-secrets-and-load-configuration-values-basic-sample"></a><span data-ttu-id="49105-126">Создать секретных кодов хранилища ключей и загрузить значения конфигурации (basic образец)</span><span class="sxs-lookup"><span data-stu-id="49105-126">Create key vault secrets and load configuration values (basic-sample)</span></span>

1. <span data-ttu-id="49105-127">Создание хранилища ключей и настроить Azure Active Directory (Azure AD) для приложении, следуя указаниям в [приступить к работе с хранилищем ключей Azure](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="49105-127">Create a key vault and set up Azure Active Directory (Azure AD) for the app following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
   * <span data-ttu-id="49105-128">Добавьте секреты в хранилище ключей с помощью [модуль PowerShell хранилища ключей AzureRM](/powershell/module/azurerm.keyvault) корпорации [коллекции PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), [API REST хранилища ключей Azure](/rest/api/keyvault/), или [Портала azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="49105-128">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="49105-129">Секреты создаются как *вручную* или *сертификат* секреты.</span><span class="sxs-lookup"><span data-stu-id="49105-129">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="49105-130">*Сертификат* секретов, сертификатов для использования с приложениями и службами, но не поддерживаются поставщиком конфигурации.</span><span class="sxs-lookup"><span data-stu-id="49105-130">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="49105-131">Следует использовать *вручную* параметр, чтобы создать пару "имя значение" секреты для использования при помощи поставщика конфигурации.</span><span class="sxs-lookup"><span data-stu-id="49105-131">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
     * <span data-ttu-id="49105-132">Простой секретные данные создаются в виде пар "имя значение".</span><span class="sxs-lookup"><span data-stu-id="49105-132">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="49105-133">Azure имена секретов Key Vault ограничены буквы, цифры и дефисы.</span><span class="sxs-lookup"><span data-stu-id="49105-133">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
     * <span data-ttu-id="49105-134">Использование иерархических значений (разделы конфигурации) `--` (двух дефисов) как разделитель в образце.</span><span class="sxs-lookup"><span data-stu-id="49105-134">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="49105-135">Имена, которые обычно используются для разделения разделе из подраздела в [конфигурации ASP.NET Core](xref:fundamentals/configuration/index), не разрешены в именах секрета.</span><span class="sxs-lookup"><span data-stu-id="49105-135">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration/index), aren't allowed in secret names.</span></span> <span data-ttu-id="49105-136">Таким образом двух дефисов используются и поменять местами двоеточие, при загрузке секреты в конфигурацию приложения.</span><span class="sxs-lookup"><span data-stu-id="49105-136">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
     * <span data-ttu-id="49105-137">Создайте две *вручную* секретные сведения с помощью следующие пары "имя значение".</span><span class="sxs-lookup"><span data-stu-id="49105-137">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="49105-138">Первой secret — это простое имя и значение, и второй секретный код создает секретное значение с раздел и раздел имя секрета:</span><span class="sxs-lookup"><span data-stu-id="49105-138">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
       * <span data-ttu-id="49105-139">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="49105-139">`SecretName`: `secret_value_1`</span></span>
       * <span data-ttu-id="49105-140">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="49105-140">`Section--SecretName`: `secret_value_2`</span></span>
   * <span data-ttu-id="49105-141">Регистрация примера приложения с Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="49105-141">Register the sample app with Azure Active Directory.</span></span>
   * <span data-ttu-id="49105-142">Авторизуйте приложение для доступа к хранилищу ключей.</span><span class="sxs-lookup"><span data-stu-id="49105-142">Authorize the app to access the key vault.</span></span> <span data-ttu-id="49105-143">При использовании `Set-AzureRmKeyVaultAccessPolicy` командлет PowerShell, чтобы авторизовать приложение для доступа к хранилищу ключей предоставляют `List` и `Get` доступ к секретам с `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="49105-143">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>

2. <span data-ttu-id="49105-144">Обновление приложения *appsettings.json* файла со значениями `Vault`, `ClientId`, и `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="49105-144">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="49105-145">Запуск примера приложения, который получает свои значения конфигурации из `IConfigurationRoot` с тем же именем, что имя секрета.</span><span class="sxs-lookup"><span data-stu-id="49105-145">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
   * <span data-ttu-id="49105-146">Non иерархических значения: значение `SecretName` получается с помощью `config["SecretName"]`.</span><span class="sxs-lookup"><span data-stu-id="49105-146">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
   * <span data-ttu-id="49105-147">Иерархические значения (разделов): использование `:` нотации (двоеточие) или `GetSection` метода расширения.</span><span class="sxs-lookup"><span data-stu-id="49105-147">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="49105-148">Чтобы получить значение конфигурации, следует используйте один из этих подходов:</span><span class="sxs-lookup"><span data-stu-id="49105-148">Use either of these approaches to obtain the configuration value:</span></span>
     * `config["Section:SecretName"]`
     * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="49105-149">При запуске приложения, веб-страницы показывает загруженные значения секрета:</span><span class="sxs-lookup"><span data-stu-id="49105-149">When you run the app, a webpage shows the loaded secret values:</span></span>

![Окно браузера с значения секретов, загруженном с помощью конфигурации Azure Key Vault Provider](key-vault-configuration/_static/sample1.png)

## <a name="create-prefixed-key-vault-secrets-and-load-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="49105-151">Создание секретов с префиксом хранилища ключей и загрузить значения конфигурации (ключ имя префикс sample)</span><span class="sxs-lookup"><span data-stu-id="49105-151">Create prefixed key vault secrets and load configuration values (key-name-prefix-sample)</span></span>

<span data-ttu-id="49105-152">`AddAzureKeyVault` также содержит перегрузку, которая принимает реализацию `IKeyVaultSecretManager`, который позволяет управлять ключевых секреты хранилища преобразуются в ключи конфигурации.</span><span class="sxs-lookup"><span data-stu-id="49105-152">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="49105-153">Например можно реализовать интерфейс для загрузки значения секретов, исходя из значения префикса, указанные вами при запуске приложения.</span><span class="sxs-lookup"><span data-stu-id="49105-153">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="49105-154">Это позволяет, например, загружать секреты, в зависимости от версии приложения.</span><span class="sxs-lookup"><span data-stu-id="49105-154">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="49105-155">Для размещения секреты для нескольких приложений в том же хранилище ключей или для размещения среды секреты не используйте префиксы секретных кодов хранилища ключей (например, *разработки* и *рабочей* секретов) в одну хранилище.</span><span class="sxs-lookup"><span data-stu-id="49105-155">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* versus *production* secrets) into the same vault.</span></span> <span data-ttu-id="49105-156">Мы рекомендуем различных приложений и сред разработки, эксплуатации использовать отдельные хранилища ключей для изоляции среды приложений для обеспечения максимальной безопасности.</span><span class="sxs-lookup"><span data-stu-id="49105-156">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="49105-157">С помощью второго примера приложения создайте секрет в хранилище ключей для `5000-AppSecret` (периоды не допускаются в именах секрета хранилища ключей) представляющий секрет приложения для версии 5.0.0.0 вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="49105-157">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="49105-158">Для другой версии, 5.1.0.0, создать секрет для `5100-AppSecret`.</span><span class="sxs-lookup"><span data-stu-id="49105-158">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="49105-159">Каждая версия приложения загружает собственную секретное значение в его конфигурацию в качестве `AppSecret`, удаление версии при загрузке секрет.</span><span class="sxs-lookup"><span data-stu-id="49105-159">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="49105-160">Ниже приведен пример реализации:</span><span class="sxs-lookup"><span data-stu-id="49105-160">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=18)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="49105-161">`Load` Метод вызывается с помощью алгоритма поставщик, выполняющий итерацию секреты хранилища, чтобы найти те, которые имеют префикс версии.</span><span class="sxs-lookup"><span data-stu-id="49105-161">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="49105-162">Найденный префикс версии с `Load`, алгоритм использует `GetKey` метод, чтобы вернуть имя конфигурации имя секрета.</span><span class="sxs-lookup"><span data-stu-id="49105-162">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="49105-163">Она отсекает версии префикс из имени секрета и возвращает остальные имя секрета для загрузки в конфигурацию приложения пары "имя значение".</span><span class="sxs-lookup"><span data-stu-id="49105-163">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="49105-164">При реализации этого подхода:</span><span class="sxs-lookup"><span data-stu-id="49105-164">When you implement this approach:</span></span>

1. <span data-ttu-id="49105-165">Загружаются секретных кодов хранилища ключей.</span><span class="sxs-lookup"><span data-stu-id="49105-165">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="49105-166">Секрет строка `5000-AppSecret` совпадении.</span><span class="sxs-lookup"><span data-stu-id="49105-166">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="49105-167">Версии, `5000` (с dash), удаляются из имени ключа оставляя `AppSecret` загружать данные с помощью секретное значение в конфигурацию приложения.</span><span class="sxs-lookup"><span data-stu-id="49105-167">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="49105-168">Можно также предоставить собственную `KeyVaultClient` реализацию `AddAzureKeyVault`.</span><span class="sxs-lookup"><span data-stu-id="49105-168">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="49105-169">Предоставление пользовательского клиента позволяет совместно использовать один экземпляр клиента между поставщик конфигурации и другие части приложения.</span><span class="sxs-lookup"><span data-stu-id="49105-169">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="49105-170">Создание хранилища ключей и настроить Azure Active Directory (Azure AD) для приложении, следуя указаниям в [приступить к работе с хранилищем ключей Azure](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="49105-170">Create a key vault and set up Azure Active Directory (Azure AD) for the app following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
   * <span data-ttu-id="49105-171">Добавьте секреты в хранилище ключей с помощью [модуль PowerShell хранилища ключей AzureRM](/powershell/module/azurerm.keyvault) корпорации [коллекции PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), [API REST хранилища ключей Azure](/rest/api/keyvault/), или [Портала azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="49105-171">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="49105-172">Секреты создаются как *вручную* или *сертификат* секреты.</span><span class="sxs-lookup"><span data-stu-id="49105-172">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="49105-173">*Сертификат* секретов, сертификатов для использования с приложениями и службами, но не поддерживаются поставщиком конфигурации.</span><span class="sxs-lookup"><span data-stu-id="49105-173">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="49105-174">Следует использовать *вручную* параметр, чтобы создать пару "имя значение" секреты для использования при помощи поставщика конфигурации.</span><span class="sxs-lookup"><span data-stu-id="49105-174">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
     * <span data-ttu-id="49105-175">Использование иерархических значений (разделы конфигурации) `--` (двух дефисов) в качестве разделителя.</span><span class="sxs-lookup"><span data-stu-id="49105-175">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
     * <span data-ttu-id="49105-176">Создайте две *вручную* секретные сведения с помощью следующие пары "имя значение":</span><span class="sxs-lookup"><span data-stu-id="49105-176">Create two *Manual* secrets with the following name-value pairs:</span></span>
       * <span data-ttu-id="49105-177">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="49105-177">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
       * <span data-ttu-id="49105-178">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="49105-178">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
   * <span data-ttu-id="49105-179">Регистрация примера приложения с Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="49105-179">Register the sample app with Azure Active Directory.</span></span>
   * <span data-ttu-id="49105-180">Авторизуйте приложение для доступа к хранилищу ключей.</span><span class="sxs-lookup"><span data-stu-id="49105-180">Authorize the app to access the key vault.</span></span> <span data-ttu-id="49105-181">При использовании `Set-AzureRmKeyVaultAccessPolicy` командлет PowerShell, чтобы авторизовать приложение для доступа к хранилищу ключей предоставляют `List` и `Get` доступ к секретам с `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="49105-181">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>

2. <span data-ttu-id="49105-182">Обновление приложения *appsettings.json* файла со значениями `Vault`, `ClientId`, и `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="49105-182">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="49105-183">Запуск примера приложения, который получает свои значения конфигурации из `IConfigurationRoot` с тем же именем, что имя с префиксом секрета.</span><span class="sxs-lookup"><span data-stu-id="49105-183">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="49105-184">В этом примере используется версия приложения, который вы указали для префикс `PrefixKeyVaultSecretManager` при добавлении поставщика конфигурации Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="49105-184">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="49105-185">Значение для `AppSecret` получается с помощью `config["AppSecret"]`.</span><span class="sxs-lookup"><span data-stu-id="49105-185">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="49105-186">Веб-страницы, созданное приложением отображается значение загрузки:</span><span class="sxs-lookup"><span data-stu-id="49105-186">The webpage generated by the app shows the loaded value:</span></span>

   ![Окно браузера, показывающее значение секрета, загруженном с помощью конфигурации Azure Key Vault Provider при 5.0.0.0 версия приложения](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="49105-188">Изменить версию сборки приложения в файле проекта из `5.0.0.0` для `5.1.0.0` и снова запустите приложение.</span><span class="sxs-lookup"><span data-stu-id="49105-188">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="49105-189">На этот раз секретный возвращаемое значение `5.1.0.0_secret_value`.</span><span class="sxs-lookup"><span data-stu-id="49105-189">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="49105-190">Веб-страницы, созданное приложением отображается значение загрузки:</span><span class="sxs-lookup"><span data-stu-id="49105-190">The webpage generated by the app shows the loaded value:</span></span>

   ![Окно браузера, показывающее значение секрета, загруженном с помощью конфигурации Azure Key Vault Provider при 5.1.0.0 версия приложения](key-vault-configuration/_static/sample2-2.png)

## <a name="control-access-to-the-clientsecret"></a><span data-ttu-id="49105-192">Управление доступом к ClientSecret</span><span class="sxs-lookup"><span data-stu-id="49105-192">Control access to the ClientSecret</span></span>

<span data-ttu-id="49105-193">Используйте [средство Secret Manager](xref:security/app-secrets) для поддержания `ClientSecret` за пределами дерево исходного кода проекта.</span><span class="sxs-lookup"><span data-stu-id="49105-193">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="49105-194">В менеджере секретов связывается с определенным проектом секретов приложения и использовать их для нескольких проектов.</span><span class="sxs-lookup"><span data-stu-id="49105-194">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="49105-195">Разработка приложения .NET Framework в среде, которая поддерживает сертификаты, можно выполнить в хранилище ключей Azure с использованием сертификата X.509.</span><span class="sxs-lookup"><span data-stu-id="49105-195">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="49105-196">Закрытый ключ сертификата X.509 находится под управлением операционной системы.</span><span class="sxs-lookup"><span data-stu-id="49105-196">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="49105-197">Дополнительные сведения см. в разделе [проверка подлинности с помощью сертификата вместо секрета клиента](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span><span class="sxs-lookup"><span data-stu-id="49105-197">For more information, see [Authenticate with a Certificate instead of a Client Secret](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="49105-198">Используйте `AddAzureKeyVault` перегрузку, которая принимает `X509Certificate2` (`_env` в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="49105-198">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2` (`_env` in the following example :</span></span>

```csharp
var builtConfig = config.Build();

var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates
    .Find(X509FindType.FindByThumbprint, 
        config["CertificateThumbprint"], false);

config.AddAzureKeyVault(
    builtConfig["Vault"],
    builtConfig["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(context.HostingEnvironment.ApplicationName));

store.Close();
```

## <a name="reload-secrets"></a><span data-ttu-id="49105-199">Перезагрузить секретов</span><span class="sxs-lookup"><span data-stu-id="49105-199">Reload secrets</span></span>

<span data-ttu-id="49105-200">Секреты, кэшируются до `IConfigurationRoot.Reload()` вызывается.</span><span class="sxs-lookup"><span data-stu-id="49105-200">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="49105-201">Истек, отключена, и обновленные секреты в хранилище ключей не учитываются в приложении до `Reload` выполняется.</span><span class="sxs-lookup"><span data-stu-id="49105-201">Expired, disabled, and updated secrets in the key vault are not respected by the app until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="49105-202">Отключенные и истекшим сроком действия секретов</span><span class="sxs-lookup"><span data-stu-id="49105-202">Disabled and expired secrets</span></span>

<span data-ttu-id="49105-203">Отключенные и просроченные секреты throw `KeyVaultClientException`.</span><span class="sxs-lookup"><span data-stu-id="49105-203">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="49105-204">Чтобы избежать возникновения в приложении, замените приложение или изменить секрет просроченного отключено.</span><span class="sxs-lookup"><span data-stu-id="49105-204">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshoot"></a><span data-ttu-id="49105-205">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="49105-205">Troubleshoot</span></span>

<span data-ttu-id="49105-206">Если приложение не удается загрузить конфигурацию с помощью поставщика, сообщение об ошибке записывается [инфраструктуры ведения журнала ASP.NET Core](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="49105-206">When the app fails to load configuration using the provider, an error message is written to the [ASP.NET Core Logging infrastructure](xref:fundamentals/logging/index).</span></span> <span data-ttu-id="49105-207">Следующие условия не позволит конфигурации загрузки:</span><span class="sxs-lookup"><span data-stu-id="49105-207">The following conditions will prevent configuration from loading:</span></span>

* <span data-ttu-id="49105-208">Приложение не настроено правильно, в Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="49105-208">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="49105-209">Хранилище ключей не существует в хранилище ключей Azure.</span><span class="sxs-lookup"><span data-stu-id="49105-209">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="49105-210">Приложение не имеет разрешения на доступ к хранилищу ключей.</span><span class="sxs-lookup"><span data-stu-id="49105-210">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="49105-211">Политика доступа не включает `Get` и `List` разрешения.</span><span class="sxs-lookup"><span data-stu-id="49105-211">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="49105-212">В хранилище ключей данные конфигурации (пара «имя значение») ошибочно названы, отсутствуют, отключена или истек срок действия.</span><span class="sxs-lookup"><span data-stu-id="49105-212">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="49105-213">Приложение имеет имя неправильный хранилища ключей (`Vault`), идентификатор приложения Azure AD (`ClientId`), или ключ Azure AD (`ClientSecret`).</span><span class="sxs-lookup"><span data-stu-id="49105-213">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="49105-214">Ключ Azure AD (`ClientSecret`) срок действия истек.</span><span class="sxs-lookup"><span data-stu-id="49105-214">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="49105-215">В приложении для значения, которое вы пытаетесь загрузить неправильный ключ конфигурации (имя).</span><span class="sxs-lookup"><span data-stu-id="49105-215">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="49105-216">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="49105-216">Additional resources</span></span>

* <xref:fundamentals/configuration/index>
* [<span data-ttu-id="49105-217">Microsoft Azure: Хранилище ключей</span><span class="sxs-lookup"><span data-stu-id="49105-217">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="49105-218">Microsoft Azure: Документация по хранилищу ключей</span><span class="sxs-lookup"><span data-stu-id="49105-218">Microsoft Azure: Key Vault Documentation</span></span>](/azure/key-vault/)
* [<span data-ttu-id="49105-219">Использование защищенных аппаратным модулем безопасности и их передача ключей для хранилища ключей Azure</span><span class="sxs-lookup"><span data-stu-id="49105-219">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="49105-220">Класс KeyVaultClient</span><span class="sxs-lookup"><span data-stu-id="49105-220">KeyVaultClient Class</span></span>](/dotnet/api/microsoft.azure.keyvault.keyvaultclient)
