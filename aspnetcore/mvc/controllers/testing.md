---
title: Тестирование логики контроллера в ASP.NET Core
author: ardalis
description: Узнайте, как протестировать логику контроллера в ASP.NET Core с помощью Moq и xUnit.
ms.author: riande
ms.date: 10/14/2016
uid: mvc/controllers/testing
ms.openlocfilehash: d0b2a25d00187c088671be147844aa892f824c6e
ms.sourcegitcommit: 64c2ca86fff445944b155635918126165ee0f8aa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2018
ms.locfileid: "41751763"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="b4106-103">Тестирование логики контроллера в ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="b4106-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="b4106-104">Автор: [Стив Смит](https://ardalis.com/) (Steve Smith)</span><span class="sxs-lookup"><span data-stu-id="b4106-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="b4106-105">Контроллеры — это центральный элемент любого приложения ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="b4106-105">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="b4106-106">По этой причине необходима уверенность в том, что они работают, как планировалось.</span><span class="sxs-lookup"><span data-stu-id="b4106-106">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="b4106-107">С помощью автоматических тестов можно убедиться в этом и обнаружить ошибки до ввода контроллеров в рабочую среду.</span><span class="sxs-lookup"><span data-stu-id="b4106-107">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="b4106-108">Важно избегать реализации в контроллерах лишних функций, а тесты должны быть ориентированы только на функции контроллеров.</span><span class="sxs-lookup"><span data-stu-id="b4106-108">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="b4106-109">Логике контролера следует быть минимальной и не связанной с бизнес-логикой или проблемами инфраструктуры (например, с доступом к данным).</span><span class="sxs-lookup"><span data-stu-id="b4106-109">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="b4106-110">Тестировать нужно логику контроллера, а не платформу.</span><span class="sxs-lookup"><span data-stu-id="b4106-110">Test controller logic, not the framework.</span></span> <span data-ttu-id="b4106-111">Тестируйте *работу* контроллера на основе допустимых и недопустимых значений.</span><span class="sxs-lookup"><span data-stu-id="b4106-111">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="b4106-112">Проверяйте ответы контроллера на основе результата выполняемой им бизнес-операции.</span><span class="sxs-lookup"><span data-stu-id="b4106-112">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="b4106-113">Типичные функции контроллера:</span><span class="sxs-lookup"><span data-stu-id="b4106-113">Typical controller responsibilities:</span></span>

* <span data-ttu-id="b4106-114">Проверяет значение `ModelState.IsValid`.</span><span class="sxs-lookup"><span data-stu-id="b4106-114">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="b4106-115">Возвращает ответ об ошибке, если состояние `ModelState` недопустимо.</span><span class="sxs-lookup"><span data-stu-id="b4106-115">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="b4106-116">Возвращает бизнес-элемент из хранилища.</span><span class="sxs-lookup"><span data-stu-id="b4106-116">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="b4106-117">Выполняет действие с бизнес-элементом.</span><span class="sxs-lookup"><span data-stu-id="b4106-117">Perform an action on the business entity.</span></span>
* <span data-ttu-id="b4106-118">Сохраняет бизнес-элемент в хранилище.</span><span class="sxs-lookup"><span data-stu-id="b4106-118">Save the business entity to persistence.</span></span>
* <span data-ttu-id="b4106-119">Возвращает соответствующий результат `IActionResult`.</span><span class="sxs-lookup"><span data-stu-id="b4106-119">Return an appropriate `IActionResult`.</span></span>

<span data-ttu-id="b4106-120">[Просмотреть или скачать образец кода](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([как скачивать](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="b4106-120">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="unit-tests-of-controller-logic"></a><span data-ttu-id="b4106-121">Модульное тестирование логики контроллера</span><span class="sxs-lookup"><span data-stu-id="b4106-121">Unit tests of controller logic</span></span>

<span data-ttu-id="b4106-122">[Модульное тестирование](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) предполагает тестирование части приложения изолированно от его инфраструктуры и зависимостей.</span><span class="sxs-lookup"><span data-stu-id="b4106-122">[Unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involve testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="b4106-123">При модульном тестировании логики контроллера тестируется только содержимое отдельного действия, но не поведение его зависимостей или сама платформа.</span><span class="sxs-lookup"><span data-stu-id="b4106-123">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="b4106-124">Выполняя модульное тестирование действий контроллера, следует сосредоточиться только на его поведении.</span><span class="sxs-lookup"><span data-stu-id="b4106-124">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="b4106-125">В рамках модульного тестирования контроллера не учитываются такие аспекты, как [фильтры](xref:mvc/controllers/filters), [маршрутизация](xref:fundamentals/routing) или [привязка модели](xref:mvc/models/model-binding).</span><span class="sxs-lookup"><span data-stu-id="b4106-125">A controller unit test avoids things like [filters](xref:mvc/controllers/filters), [routing](xref:fundamentals/routing), or [model binding](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="b4106-126">Благодаря нацеленности на отдельный компонент модульные тесты, как правило, проще создавать, а выполняются они быстрее.</span><span class="sxs-lookup"><span data-stu-id="b4106-126">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="b4106-127">Правильно составленный набор модульных тестов можно выполнять часто без значительных затрат.</span><span class="sxs-lookup"><span data-stu-id="b4106-127">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="b4106-128">Однако модульные тесты не выявляют проблемы с взаимодействием между компонентами. Для этого используется [тестирование интеграции](xref:test/integration-tests).</span><span class="sxs-lookup"><span data-stu-id="b4106-128">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:test/integration-tests).</span></span>

<span data-ttu-id="b4106-129">Если вы создаете пользовательские фильтры и маршруты, их следует подвергать модульному тестированию изолированно, но не в рамках тестирования определенного действия контроллера.</span><span class="sxs-lookup"><span data-stu-id="b4106-129">If you're writing custom filters and routes, you should unit test them in isolation, not as part of your tests on a particular controller action.</span></span>

> [!TIP]
> <span data-ttu-id="b4106-130">[Создавайте и выполняйте модульные тесты с помощью Visual Studio](/visualstudio/test/unit-test-your-code).</span><span class="sxs-lookup"><span data-stu-id="b4106-130">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="b4106-131">Для демонстрации модульного тестирования рассмотрим представленный ниже контроллер.</span><span class="sxs-lookup"><span data-stu-id="b4106-131">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="b4106-132">Он выводит список сеансов мозгового штурма и позволяет создавать такие сеансы с помощью запроса POST.</span><span class="sxs-lookup"><span data-stu-id="b4106-132">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="b4106-133">Контроллер следует [принципу явных зависимостей](http://deviq.com/explicit-dependencies-principle/), предполагающему предоставление экземпляра `IBrainstormSessionRepository` при внедрении зависимостей.</span><span class="sxs-lookup"><span data-stu-id="b4106-133">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="b4106-134">Благодаря этому его достаточно легко протестировать с помощью платформы макетов объектов, например [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="b4106-134">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="b4106-135">В методе `HTTP GET Index` нет циклов или ветвления, и он вызывает лишь один метод.</span><span class="sxs-lookup"><span data-stu-id="b4106-135">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="b4106-136">Чтобы протестировать этот метод `Index`, необходимо проверить, возвращается ли результат `ViewResult` с объектом `ViewModel` из метода `List` репозитория.</span><span class="sxs-lookup"><span data-stu-id="b4106-136">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="b4106-137">Метод `HomeController` `HTTP POST Index` (показанный выше) должен проверять, выполняются ли следующие действия:</span><span class="sxs-lookup"><span data-stu-id="b4106-137">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="b4106-138">Метод действия возвращает результат `ViewResult` типа "Неверный запрос" с соответствующими данными, если свойство `ModelState.IsValid` имеет значение `false`.</span><span class="sxs-lookup"><span data-stu-id="b4106-138">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`.</span></span>

* <span data-ttu-id="b4106-139">Вызывается метод `Add` репозитория, и возвращается результат `RedirectToActionResult` с правильными аргументами, если свойство `ModelState.IsValid` имеет значение true.</span><span class="sxs-lookup"><span data-stu-id="b4106-139">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="b4106-140">Недопустимое состояние модели можно проверить, добавив ошибки с помощью метода `AddModelError`, как показано в первом тесте ниже.</span><span class="sxs-lookup"><span data-stu-id="b4106-140">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="b4106-141">Первый тест проверяет, возвращается ли тот же результат `ViewResult`, что и для запроса `GET`, если состояние `ModelState` недопустимо.</span><span class="sxs-lookup"><span data-stu-id="b4106-141">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="b4106-142">Обратите внимание на то, что он не пытается передать недопустимую модель.</span><span class="sxs-lookup"><span data-stu-id="b4106-142">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="b4106-143">Это бы в любом случае не удалось, так как привязка модели не запущена (хотя [тест интеграции](xref:test/integration-tests) использовал бы тестовую привязку модели).</span><span class="sxs-lookup"><span data-stu-id="b4106-143">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:test/integration-tests) would use exercise model binding).</span></span> <span data-ttu-id="b4106-144">В этом случае привязка модели не тестируется.</span><span class="sxs-lookup"><span data-stu-id="b4106-144">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="b4106-145">Эти модульные тесты проверяют только действия, выполняемые кодом в методе действия.</span><span class="sxs-lookup"><span data-stu-id="b4106-145">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="b4106-146">Второй тест проверяет, добавляется ли новый объект `BrainstormSession` (через репозиторий) и возвращает ли метод результат `RedirectToActionResult` с ожидаемыми свойствами, если состояние `ModelState` допустимо.</span><span class="sxs-lookup"><span data-stu-id="b4106-146">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="b4106-147">Макеты вызовов, которые не выполняются, обычно игнорируются, но вызов `Verifiable` в конце вызова Setup позволяет проверить его в тесте.</span><span class="sxs-lookup"><span data-stu-id="b4106-147">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="b4106-148">Для этого служит вызов метода `mockRepo.Verify`, в результате которого тест будет считаться непройденным, если требуемый метод не был вызван.</span><span class="sxs-lookup"><span data-stu-id="b4106-148">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="b4106-149">Библиотека Moq, используемая в этом примере, позволяет легко сочетать проверяемые (строгие) макеты и непроверяемые (которые также называют нестрогими макетами или заглушками).</span><span class="sxs-lookup"><span data-stu-id="b4106-149">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="b4106-150">Узнайте больше о [настройке поведения макетов с помощью Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="b4106-150">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="b4106-151">Другой контроллер в приложении выводит сведения, связанные с определенным сеансом мозгового штурма.</span><span class="sxs-lookup"><span data-stu-id="b4106-151">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="b4106-152">Он содержит логику для обработки недопустимых значений id:</span><span class="sxs-lookup"><span data-stu-id="b4106-152">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="b4106-153">Действие контроллера имеет три тестируемых случая, по одному на каждый оператор `return`:</span><span class="sxs-lookup"><span data-stu-id="b4106-153">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="b4106-154">Приложение предоставляет функциональные возможности в виде веб-интерфейса API (список идей, связанных с сеансом мозгового штурма, и метод для добавления новых идей в сеанс):</span><span class="sxs-lookup"><span data-stu-id="b4106-154">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="b4106-155">Метод `ForSession` возвращает список типов `IdeaDTO`.</span><span class="sxs-lookup"><span data-stu-id="b4106-155">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="b4106-156">Старайтесь не возвращать бизнес-элементы непосредственно через вызовы API, так как они часто содержат больше данных, чем требуется клиенту API, и связывают внутреннюю модель предметной области приложения с интерфейсом API, доступным извне, чего следует избегать.</span><span class="sxs-lookup"><span data-stu-id="b4106-156">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="b4106-157">Сопоставлять элементы предметной области и типы, возвращаемые по сети, можно вручную (с помощью инструкции LINQ `Select`, как показано здесь) или с помощью такой библиотеки, как [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span><span class="sxs-lookup"><span data-stu-id="b4106-157">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span></span>

<span data-ttu-id="b4106-158">Модульные тесты для методов API `Create` и `ForSession`:</span><span class="sxs-lookup"><span data-stu-id="b4106-158">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="b4106-159">Как уже говорилось ранее, чтобы протестировать поведение метода в случае, если состояние `ModelState` недопустимо, следует добавить ошибку модели в контроллер в рамках теста.</span><span class="sxs-lookup"><span data-stu-id="b4106-159">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="b4106-160">Не пытайтесь тестировать проверку модели или привязку модели с помощью модульных тестов — проверяйте только поведение метода действия при определенных значениях `ModelState`.</span><span class="sxs-lookup"><span data-stu-id="b4106-160">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="b4106-161">Во втором тесте предполагается, что репозиторий возвращает значение NULL, поэтому макет репозитория настроен так, чтобы возвращать значение NULL.</span><span class="sxs-lookup"><span data-stu-id="b4106-161">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="b4106-162">Создавать тестовую базу данных (в памяти или где-либо еще) и запрос, возвращающий этот результат, не нужно — это можно сделать в одном операторе, как показано в примере.</span><span class="sxs-lookup"><span data-stu-id="b4106-162">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="b4106-163">Последний тест проверяет, вызывается ли метод `Update` репозитория.</span><span class="sxs-lookup"><span data-stu-id="b4106-163">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="b4106-164">Как и ранее, макет вызывается с помощью метода `Verifiable`, а затем вызывается метод `Verify` макета репозитория для подтверждения выполнения проверяемого метода.</span><span class="sxs-lookup"><span data-stu-id="b4106-164">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="b4106-165">Проверка того, сохранил ли метод `Update` данные, не относится к задачам модульного теста. Это можно сделать с помощью теста интеграции.</span><span class="sxs-lookup"><span data-stu-id="b4106-165">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="b4106-166">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="b4106-166">Additional resources</span></span>

* <xref:test/integration-tests>
